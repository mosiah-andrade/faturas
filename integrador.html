<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Detalhes do Integrador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background-color: #f8f9fa; margin: 20px; }
        .container { background: #ffffff; padding: 40px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 800px; box-sizing: border-box; }
        .integrador-info { text-align: center; border-bottom: 1px solid #dee2e6; padding-bottom: 20px; margin-bottom: 20px; }
        h1, h2 { text-align: center; color: #212529; }
        #clientes-lista { list-style-type: none; padding: 0; }
        #clientes-lista li { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .cliente-dados { flex-grow: 1; }
        .cliente-acoes { display: flex; gap: 10px; }
        .action-btn { background-color: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; text-decoration: none; text-align: center; }
        .ver-faturas-btn { background-color: #28a745; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border-radius: 12px; max-width: 500px; position: relative; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 15px; } label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; }
        #message-modal { margin-top: 15px; padding: 10px; border-radius: 6px; text-align: center; display: none; }
        .success { background-color: #d1e7dd; color: #0f5132; display: block; } .error { background-color: #f8d7da; color: #842029; display: block; }
        .back-link { display: block; text-align: center; margin-top: 20px; color: #ff9900; font-weight: 600; }
    </style>
</head>
<body>

    <div class="container" id="main-container"><p>Carregando...</p></div>

    <div id="faturaModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Gerar Nova Fatura</h2>
            <form id="faturaForm">
                <input type="hidden" id="instalacao_id_modal">
                <div class="form-group">
                    <label>Cliente:</label>
                    <input type="text" id="cliente_nome_modal" readonly disabled>
                </div>
                <div class="form-group">
                    <label for="mes_referencia">Mês de Referência:</label>
                    <input type="month" id="mes_referencia" required>
                </div>
                <div class="form-group">
                    <label for="consumo_kwh">Consumo da Rede (kWh):</label>
                    <input type="number" step="0.01" id="consumo_kwh" required>
                </div>
                <div class="form-group">
                    <label for="injecao_kwh">Energia Injetada (kWh):</label>
                    <input type="number" step="0.01" id="injecao_kwh" required>
                </div>
                <button type="submit" id="submitFaturaBtn" class="action-btn">Salvar Fatura</button>
                <div id="message-modal"></div>
            </form>
        </div>
    </div>

    <script>
        const API_GET_INTEGRADOR = 'api/get_integrador.php';
        const API_GET_CLIENTES = 'api/get_clientes_por_integrador.php';
        const API_GERAR_FATURA = 'api/gerar_fatura.php';

        const container = document.getElementById('main-container');
        const modal = document.getElementById('faturaModal');
        const closeModalBtn = document.querySelector('.close-btn');

        function getQueryParam(param) { return new URLSearchParams(window.location.search).get(param); }
        
        function openFaturaModal(instalacaoId, clienteNome) {
            document.getElementById('faturaForm').reset();
            document.getElementById('message-modal').style.display = 'none';
            document.getElementById('instalacao_id_modal').value = instalacaoId;
            document.getElementById('cliente_nome_modal').value = clienteNome;
            modal.style.display = 'block';
        }
        
        closeModalBtn.onclick = () => { modal.style.display = 'none'; };
        window.onclick = (event) => { if (event.target == modal) { modal.style.display = 'none'; } };

        document.getElementById('faturaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitFaturaBtn');
            const messageDiv = document.getElementById('message-modal');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processando...';
            messageDiv.className = '';
            
            const data = {
                instalacao_id: document.getElementById('instalacao_id_modal').value,
                mes_referencia: document.getElementById('mes_referencia').value,
                consumo_kwh: document.getElementById('consumo_kwh').value,
                injecao_kwh: document.getElementById('injecao_kwh').value,
            };

            try {
                const response = await fetch(API_GERAR_FATURA, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                
                messageDiv.textContent = result.message;
                messageDiv.className = 'success';
                setTimeout(() => { modal.style.display = 'none'; }, 2000);
            } catch (error) {
                messageDiv.textContent = error.message;
                messageDiv.className = 'error';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Salvar Fatura';
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const integradorId = getQueryParam('id');
            if (!integradorId) {
                container.innerHTML = '<h1>ID do integrador não fornecido.</h1>';
                return;
            }

            try {
                // Busca dados do integrador
                const integradorResponse = await fetch(`${API_GET_INTEGRADOR}?id=${integradorId}`);
                if (!integradorResponse.ok) throw new Error('Falha ao buscar dados do integrador.');
                const integrador = await integradorResponse.json();

                // Busca clientes do integrador
                const clientesResponse = await fetch(`${API_GET_CLIENTES}?integrador_id=${integradorId}`);
                if (!clientesResponse.ok) throw new Error('Falha ao buscar clientes.');
                const clientes = await clientesResponse.json();

                let clientesHtml = '<li>Nenhum cliente vinculado.</li>';
                if (clientes.length > 0) {
                    clientesHtml = clientes.map(cliente => `
                        <li>
                            <div class="cliente-dados">
                                <div>${cliente.nome}</div>
                                <small>UC: ${cliente.codigo_uc}</small>
                            </div>
                            <div class="cliente-acoes">
                                <a href="faturas.html?cliente_id=${cliente.cliente_id}" class="action-btn ver-faturas-btn">Ver Faturas</a>
                                <button class="action-btn" onclick="openFaturaModal(${cliente.instalacao_id}, '${cliente.nome}')">Gerar Fatura</button>
                            </div>
                        </li>
                    `).join('');
                }

                // Renderiza a página completa
                container.innerHTML = `
                    <div class="integrador-info">
                        <h1>${integrador.nome_do_integrador}</h1>
                        <p>${integrador.numero_de_contato}</p>
                    </div>
                    <div>
                        <h2>Clientes Vinculados</h2>
                        <ul id="clientes-lista">${clientesHtml}</ul>
                    </div>
                    <a href="index.html" class="back-link">&larr; Voltar ao Painel Principal</a>
                `;

            } catch (error) {
                container.innerHTML = `<h1>Erro ao carregar a página: ${error.message}</h1>`;
            }
        });
    </script>
</body>
</html>